# MinDepthCompiler


Please consult artifact evaluation instructions located at https://github.com/CaT-mindepth/CaT-AE for more information before you start.


## Running

To use the Domino backend and generate a `.json` file: (using the `learn_filter` benchmark as an example)
First run the preprocessor (https://github.com/CaT-mindepth/CaT-Preprocessor) using 
```
./domino <input Domino program> > <output filename>
```
Then run the code generator (for the Domino backend):
```
cd src/
python3 ./main-domino.py ./learn_filter.in _learn_filter_out learn_filter.json # it will output to learn_filter.json with intermediate sketch files located at _learn_filter_out
# cleanup:
rm -rf _learn_filter_out
```


<strong>Note</strong>: the default mode of minDepthCompiler enables debug printouts and disables predecessor packing optimization. To enable full optimization and discard unwanted debug printouts, please consult the "Additional flags" section below.

<br><br>


To use the Tofino backend:
```
cd src/
python3 ./main-single.py ./blue_decrease.in _blue_decrease_out  blue_decrease.json
```


## Additional flags

To generate code for FPGA verification on the Menshen simulator: you need to add the `--fpgaVerify` flag

<br>
To generate code <strong>with no debug printouts</strong>: you need to add the `--eval` flag

<br>
To generate code with <strong>predecessor packing enabled</strong>: you need to add the `--predPack` flag

## Intro

This project is divided into two programs: a preprocessor (https://github.com/CaT-mindepth/CaT-Preprocessor) that takes in a Domino `.c` program and outputs it into a `.in` file, and a compiler (`src/main.py`) that takes in a `.in` file, an argument specifying the folder in which intermediate sketch files can be written to, and an argument specifying the output filename. 

To call the preprocessor, run
```
./domino <Domino .c file> <output .in file>
```
To run the main compiler, you need to take a `.in` file generated by the preprocessor, and run
```
cd src/ && python3 ./main.py <path to .in file> <path to a directory for temporary files> <path to output file>
```
Along the way, the compiler will use the Graphviz `dot` command to generate and display the mid-end dependency graph and components graph as PDFs.


## Flags



## Python Dependencies
Python version: 3.5 or up
```
PLY  
networkx  
graphviz  
overrides 
jinja2 
gurobipy
```
Note that only having the pip3 graphviz package is not enough; please make sure the Graphviz `dot`-language compiler is installed on your system and available in the `PATH`. 

To install `dot` on Ubuntu:
```
sudo apt install graphviz
```

To install `dot` on macOS/OSX: Make sure to have Homebrew installed, and run
```
brew install graphviz
```
` 
## Non-python dependencies
Sketch-1.7.6

## Running the code

Go to the src directory ("cd src").

Use the command "python3 preprocessor.py \<input Domino program\> \<output file\>" to generate the preprocessed code.    

Use the command "python3 main.py \<input preprocessed file\> \<output directory\>" to generate code by querying Sketch. Sketch input files will be created in \<output directory\>.
